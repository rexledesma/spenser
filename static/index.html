<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>spenser</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&family=Red+Hat+Mono:ital,wght@0,300..700;1,300..700&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
      }

      :root {
        --font-sans:
          "Figtree", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Open Sans", "Helvetica Neue", sans-serif;

        --font-main: "Red Hat Mono", "Courier New", Courier, monospace;
      }

      ::selection {
        background-color: inherit;
        color: white;
        text-shadow: 1px 1px 2px lightcoral;
      }

      body {
        font-family: var(--font-main);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        background-color: rgb(from rosybrown r g b / 50%);
      }
      img,
      picture,
      video,
      canvas,
      svg {
        display: block;
        max-width: 100%;
      }

      input,
      button,
      textarea,
      select {
        font: inherit;
      }

      p,
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-size: inherit;
        font-weight: inherit;
        overflow-wrap: break-word;
        text-wrap: pretty;
      }

      #root,
      #__next {
        isolation: isolate;
      }
    </style>
  </head>
  <body>
    <style>
      @scope {
        display: flex;
        flex-direction: column;
        margin: 0 auto;
        padding: 1rem;
        gap: 1rem;
        max-width: 920px;

        aside {
          display: flex;
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
          border: 2px solid black;
        }

        code {
          font-weight: 600;
          padding: 0 0.25rem;
          font-family: var(--font-sans);
          font-size: 0.9rem;
          border: 2px solid gray;
          &.primary {
            border: 2px solid orange;
          }
        }

        h3 {
          font-weight: 600;
          font-size: 1.1rem;
        }

        h4 {
          font-weight: 600;
          font-family: var(--font-sans);
        }

        .warn {
          padding: 0.5rem;
          color: firebrick;
          background-color: rgb(from red r g b / 10%);
          strong {
            font-weight: 500;
          }
        }
      }
    </style>
    <div>
      <style>
        @scope {
          padding: 1rem 0;
          h1 {
            font-size: 1.5rem;
            line-height: 1;
            font-weight: 500;
            strong {
              font-weight: 600;
              &:hover {
                font-weight: 700;
                cursor: help;
              }
            }
          }

          sub {
            font-style: italic;
            line-height: 1;
            font-size: 1rem;
            font-family: var(--font-sans);
          }
        }
      </style>
      <div>
        <style>
          @scope {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 0.5rem;
          }
        </style>
        <h1>hi! my name is spen<strong>s</strong>er</h1>
        <user-box />
      </div>
      <sub>
        i'm a hot water boiler/dispenser next to the communal fridge. welcome to
        my home!
      </sub>
    </div>
    <div>
      <style>
        @scope {
          display: flex;
          @media screen and (max-width: 1080px) {
            flex-direction: column;
          }
          gap: 1rem;
          > * {
            flex: 1;
          }
        }
      </style>
      <aside>
        <h3>how to use me</h3>
        <p>
          first, hit the <code class="primary">unlock</code> button, then hit
          the <code class="primary">dispense</code> button! i will relock on my
          own.
        </p>
        <h3>how to refill me</h3>
        <p>
          take the kettle (bottom right of the tea shelf) & fill it with tap
          water. then open my top and pour the water in.
        </p>
        <p>
          if the <code>reboil</code> light is on, then i'm already boiling the
          new water! otherwise, you can also click <code>reboil</code> manually.
        </p>
        <div class="warn">
          <strong>do not click reboil when im empty!!</strong><br />i will
          overheat and hurt myself :(
        </div>
        <div class="warn">
          <strong>i am only designed for water!</strong><br />please dont put
          anything else in me.
        </div>
        <p>
          you can find the manual for me
          <a target="_blank" rel="noopener noreferrer" href="/manual.pdf"
            >here!</a
          >
        </p>
      </aside>
      <aside>
        <h3>how to clean me</h3>
        <p>
          i prefer to be emptied and refilled at the end of each day to keep the
          water fresh, and have hot water ready in the morning.
        </p>
        <p>
          i also like to be cleaned with citric acid every 1-3 months (see
          <a
            target="_blank"
            rel="noopener noreferrer"
            href="/manual.pdf#page=17"
            >page 17</a
          >).
        </p>
        <status-box></status-box>
      </aside>
    </div>
    <sub>
      <style>
        @scope {
          span {
            background-color: rgb(from mistyrose r g b / 50%);
          }
        }
      </style>
      thank you to
      <span>cyrene zhang</span>, <span>walter min</span>,
      <span>sahan paliskara</span>, <span>grace lin</span>,
      <span>nadia heredia</span>, <span>henry fellerhoff</span>,
      <span>ziv steinberger</span>, <span>chris stone</span>,
      <span>kunal marwaha</span>, <span>clarence bowen</span> for helping
      crowdfund this!
    </sub>
    <sub
      >have more questions? check
      <a
        target="_blank"
        rel="noopener noreferrer"
        href="https://recurse.zulipchat.com/#narrow/channel/398504-397-Bridge/topic/Crowdfunding.20a.20hot.20water.20dispenser"
      >
        the zulip thread
      </a>
    </sub>
    <script type="module">
      if (window.location.href.startsWith("https://spenser.rcdis.co")) {
        window.location.replace("https://spenser.recurse.com");
      }
      class UserBox extends HTMLElement {
        constructor() {
          super();
          const shadow = this.attachShadow({ mode: "open" });
          shadow.innerHTML = `
            <a id="link">
              <style>
                @scope {
                  .mouse-on {
                    display: none;
                  }
                  &:hover {
                    .mouse-off {
                      display: none;
                    }
                    .mouse-on {
                      font-weight: 500;
                      display: inline;
                    }
                  }

                  text-align: right;
                  text-decoration: underline;
                  strong {
                    font-weight: 600;
                  }
                }
              </style>
              <span id="content" class="mouse-off"></span>
              <span id="hover" class="mouse-on"></span>
            </a>
          `;
          const linkElem = shadow.getElementById("link");
          const contentElem = shadow.getElementById("content");
          const hoverElem = shadow.getElementById("hover");

          this.me().then((me) => {
            if (me) {
              contentElem.innerHTML = `you are <strong>${me}!</strong>`;
              hoverElem.innerHTML = `log out?`;
              linkElem.href = "/api/logout";
            } else {
              contentElem.innerHTML = `you are?`;
              hoverElem.innerHTML = `log in?`;
              linkElem.href = "/api/login";
            }
          });
        }

        async me() {
          const resp = await fetch("/api/me");
          const json = await resp.json();
          const name = json.first_name;
          return name;
        }
      }

      customElements.define("user-box", UserBox);
    </script>
    <script type="module">
      class StatusBox extends HTMLElement {
        constructor() {
          super();
          const shadow = this.attachShadow({ mode: "open" });

          this.getStatus().then((status) => {
            shadow.innerHTML = `
              <div>
                <style>
                  @scope {
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                  }
                </style>
                ${this.htmlStatus("emptied", status.last_emptied)}
                ${this.htmlStatus("cleaned", status.last_cleaned)}
              </div>
            `;
          });
        }

        colors = ["seagreen", "coral", "crimson"];
        benchmarks = {
          emptied: [12, 12],
          cleaned: [24 * 30, 24 * 30 * 2],
        };
        htmlStatus(verb, date) {
          const hours = Math.floor((new Date() - date) / 36e5);
          const days = Math.floor(hours / 24);
          const text =
            hours > 48
              ? `${days} day${days === 1 ? "" : "s"} ago`
              : `${hours} hour${hours === 1 ? "" : "s"} ago`;

          const benchmark = this.benchmarks[verb];
          benchmark.push(
            Math.max(48, hours + 48 - benchmark[0] - benchmark[1]),
          );
          const barProgress =
            (100 * hours) / (benchmark[0] + benchmark[1] + benchmark[2]);
          const color =
            hours < benchmark[0]
              ? this.colors[0]
              : hours < benchmark[1]
                ? this.colors[1]
                : this.colors[2];

          return `
            <div>
              <style>
                @scope {
                  display: flex;
                  flex-direction: column;
                  gap: 0.5rem;
                  padding: 1rem;
                  border: 1px solid ${color};
                }
              </style>
              <div>
                <span>i was last ${verb}</span>
                <a href="/api/status/last_${verb}">
                  <style>
                    @scope {
                      .mouse-on {
                        display: none;
                      }
                      &:hover {
                        .mouse-off {
                          display: none;
                        }
                        .mouse-on {
                          font-weight: 500;
                          display: inline;
                        }
                      }

                      color: ${color};
                      text-decoration: underline;
                    }
                  </style>
                  <span class="mouse-off">${text}.</span>
                  <span class="mouse-on">just now?</span>
                </a>
              </div>
              <div>
                <style>
                  @scope {
                    position: relative;
                    display: flex;
                    align-items: stretch;
                    height: 0.5rem;
                    .good {
                      flex: ${benchmark[0]};
                      background-color: ${this.colors[0]};
                    }
                    .meh {
                      flex: ${benchmark[1]};
                      background-color: ${this.colors[1]};
                    }
                    .bad {
                      flex: ${benchmark[2]};
                      background-color: ${this.colors[2]};
                    }

                    #bar {
                      position: absolute;
                      top: 0;
                      bottom: 0;
                      display: flex;
                      align-items: center;
                      flex-direction: column;
                      width: 0px;
                      left: ${barProgress}%;
                    }
                  }
                </style>
                <div class="good"></div>
                <div class="meh"></div>
                <div class="bad"></div>
                <div id="bar">^</div>
              </div>
            </div>
          `;
        }

        async getStatus() {
          const resp = await fetch("/api/status");
          const json = await resp.json();
          return {
            last_emptied: new Date(json.last_emptied),
            last_cleaned: new Date(json.last_cleaned),
          };
        }
      }

      // Register the new custom element with the browser
      customElements.define("status-box", StatusBox);
    </script>
  </body>
</html>
